#!/usr/bin/env bash

# shellcheck disable=SC1091

# ensure the command is run in a git repo
source __assertgitrepo

function main() {

    __assertgitrepo

    # use command line arguments if provided
    if [[ $# -gt 0 ]]; then
        [[ "$1" == "." ]] && git add -A || git add $*
        gstatus
        return
    fi

    numModifiedFiles=$(git status --short | grep "^[ ]" -c)
    numUntrackedFiles=$(git status --short | grep "^??" -c)
    if [[ $((numModifiedFiles + numUntrackedFiles)) -eq 0 ]]; then
        gstatus
        printf "\n[INFO] No unstaged files.\n"
        return
    fi

    [[ $numModifiedFiles -gt 0 ]] && stage_modified_files
    [[ $numUntrackedFiles -gt 0 ]] && stage_untracked_files

    gstatus
}

function stage_modified_files() {

    gstatus
    echo
    read -p "stage modified files? (press enter / n) : " -r
    [[ $REPLY != "" ]] && return

    git status --short | grep "^[ ]" | sed -e 's/ [A-Z] //' | \
        fzf -m --color='fg:9' | xargs git add
}

function stage_untracked_files() {

    gstatus
    echo
    read -p "stage untracked files? (press enter / n) : " -r
    [[ $REPLY != "" ]] && return

    git status --short | grep "^??" | sed -e 's/^[?]* //' | \
        fzf -m --color='fg:9' | xargs git add
}

main $*
