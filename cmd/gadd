#!/usr/bin/env bash

#shellcheck disable=SC1091
#shellcheck disable=SC2155

# ensure the command is run in a git repo
source "${__CUSTOM_GIT_UTIL}"/__assertgitrepo

function main() {

    __assertgitrepo

    numUnstagedFiles=$(git status --short | grep "^.[A-Z?] " -c)
    if [[ $numUnstagedFiles -eq 0 ]]; then
        gstatus
        printf "\n[INFO] No unstaged files.\n"
        return
    fi

    git status --short | grep "^.[A-Z?] " | fzf -m --color 'fg:160' | stage_selected_files
    # TODO: check status of this command here (fzf, xargs or git add might fail)

    gstatus
}

function stage_selected_files() {

    while read -r item; do
        if [[ "${item:0:1}" == "?" ]]; then
            local file="${item#${item:0:3}}"    # remove prefix of length 3
        else
            local file="${item#${item:0:2}}"    # remove prefix of length 2
        fi
        local rawFile="$(getrawstr "${file}")"
        git add "${rawFile}"
    done
}

if [[ $# -eq 0 ]]; then
    main
    exit 0
fi

if [[ $# -eq 1 && ( "$*" == "." || "$*" == "-A" ) ]]; then
    git add "$*"
    gstatus
    exit 0
fi

echo "[ERROR] valid inputs to gadd: \".\", \"-A\""
